name: CI

on:
  workflow_dispatch:
  push:

jobs:
  build:
    runs-on: ubuntu-24.04
    #container: ubuntu:rolling
    steps:
    - uses: actions/checkout@v4
    - name: prereqs
      run: |
        set -eux
        export DEBIAN_FRONTEND=noninteractive
        sudo sed -i 's/^Types: deb$/Types: deb deb-src/' /etc/apt/sources.list.d/ubuntu.sources
        sudo apt update
        sudo apt-get build-dep wine -y
        sudo apt install -y sudo git time wget build-essential clang mingw-w64 ccache
    - uses: Trass3r/setup-cpp@master
    - uses: hendrikmuhs/ccache-action@v1
      with:
        verbose: 2
    - name: build
      run: |
        set -eux
        mkdir -p build && cd build
        export CCACHE_STATSLOG=/tmp/stats.log
        ls -lA /usr/lib/ccache/**
        PATH="/usr/lib/ccache:$PATH" \
        ../configure --enable-win64 --disable-tests --with-mingw --enable-archs=i386,x86_64
        time make -j$(($(nproc) + 1))
        make install DESTDIR=../install
    - uses: actions/upload-artifact@v4
      with:
        name: debug
        path: /tmp/stats.log
    - uses: actions/upload-artifact@v4
      with:
        name: binaries
        path: |
          install
          build/wine*
          build/loader/wine*
          build/server/wine*
          build/fonts/
          build/nls
          build/**/*.dll
          build/**/*.exe
          build/**/*.so
